<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>家計簿アプリ</title>

  <!-- iPhone向け設定 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="家計簿">
  <!-- アイコンはあとで差し替え -->
  <link rel="apple-touch-icon" href="icon-192.png">
  <!-- 円グラフ用 Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #f5f5f5;
    }

    .app {
      min-height: 100vh;
      padding: 16px;
      padding-bottom: 80px; /* タブ分の余白 */
      box-sizing: border-box;
    }

    .view {
      display: none;
    }
    .view.active {
      display: block;
    }

    h1 {
      font-size: 22px;
      margin: 0;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-top: 8px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 16px;
      margin-top: 4px;
    }
    button {
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #007aff;
      color: #fff;
    }
    button:active {
      opacity: 0.85;
    }

    .primary-btn {
      width: 100%;
      margin-top: 12px;
    }

    .summary {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 4px;
    }
    .summary span.label {
      color: #555;
    }
    .summary span.value {
      font-weight: 600;
    }
    .records {
      max-height: 40vh;
      overflow-y: auto;
      margin-top: 8px;
    }
    .record-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .record-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .record-left {
      flex: 1;
    }
    .record-amount {
      white-space: nowrap;
    }
    .record-meta {
      font-size: 12px;
      color: #777;
      margin-top: 2px;
    }

    .expense {
      color: #d66b00; /* オレンジ（支出） */
    }
    .income {
      color: #007aff; /* 青（収入） */
    }

    .empty {
      font-size: 13px;
      color: #777;
      text-align: center;
      margin-top: 8px;
    }
    .small-text {
      font-size: 12px;
      color: #666;
    }
    .section-title {
      font-weight: 600;
      margin-top: 8px;
      font-size: 14px;
      color: #444;
    }
    .inline-input {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
    .inline-input input {
      flex: 1;
      margin-top: 0;
    }
    .inline-input button {
      margin-top: 0;
      padding-inline: 12px;
      font-size: 14px;
    }
    .highlight {
      font-weight: 700;
    }

    /* 写真ID表示 */
    .photo-id-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
      font-size: 12px;
      color: #555;
      flex-wrap: wrap;
    }
    .photo-id-label {
      font-size: 12px;
    }
    .photo-id-value {
      font-family: monospace;
      font-size: 12px;
    }
    .photo-id-copy-btn {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      color: #333;
      cursor: pointer;
    }
    .photo-id-copy-btn:active {
      opacity: 0.8;
    }

    /* 削除ボタン */
    .delete-btn {
      padding: 2px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #e06666;
      background: #fff5f5;
      color: #c03030;
      cursor: pointer;
      margin-top: 4px;
    }
    .delete-btn:active {
      opacity: 0.8;
    }

    /* カレンダー */
    .calendar-grid {
      margin-top: 8px;
    }
    .calendar-header-row,
    .calendar-cells {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-header-cell {
      text-align: center;
      font-size: 12px;
      color: #666;
    }
    .calendar-cell {
      min-height: 60px;
      background: #fafafa;
      border-radius: 8px;
      padding: 4px;
      box-sizing: border-box;
      font-size: 11px;
    }
    .calendar-cell.empty {
      background: transparent;
    }
    .calendar-day-number {
      text-align: right;
      font-size: 12px;
      margin-bottom: 2px;
    }
    .calendar-income {
      font-size: 11px;
    }
    .calendar-expense {
      font-size: 11px;
    }
    .calendar-total {
      font-size: 11px;
      font-weight: 600;
      margin-top: 2px;
    }
    .calendar-cell.today {
      border: 1px solid #007aff;
    }
    .calendar-cell.selected {
      box-shadow: 0 0 0 2px rgba(0,122,255,0.3);
    }

    /* タブバー */
    .tab-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 56px;
      background: #ffffff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 10;
    }
    .tab-button {
      flex: 1;
      height: 100%;
      background: none;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #888;
    }
    .tab-button.active {
      color: #007aff;
      font-weight: 600;
    }

    /* レポート用 予算 progress */
    .budget-row {
      display: flex;
      flex-direction: column;
      margin-top: 6px;
      font-size: 12px;
    }
    .budget-row-header {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    .budget-row-header span {
      white-space: nowrap;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #eee;
      margin-top: 2px;
      overflow: hidden;
    }
    .progress-bar-inner {
      height: 100%;
      border-radius: 999px;
    }
    .progress-ok {
      background: #007aff;
    }
    .progress-warn {
      background: #f5a623;
    }
    .progress-over {
      background: #d0021b;
    }

    .budget-list {
      margin-top: 8px;
      border-top: 1px dashed #ddd;
      padding-top: 6px;
    }
    .budget-item-line {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 4px;
      align-items: center;
      gap: 4px;
    }
    .budget-item-line button {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      color: #333;
    }
    .budget-item-line button:active {
      opacity: 0.8;
    }

    .no-chart {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
    }
	.app-version {
	  font-size: 12px;
	  margin-left: 8px;
	  color: #888;
	  font-weight: normal;
	}

  </style>
</head>
<body>
  <div class="app">
    <!-- ================= 入力タブ ================= -->
    <section id="view-input" class="view active">
	<div class="card">
	  <h1>
	    家計簿
	    <span id="app-version" class="app-version"></span>
	  </h1>
	  <p class="small-text">
	    データはこのiPhoneのブラウザ内だけに保存されます（サーバー送信なし）
	  </p>
	</div>

      <div class="card">
        <h2>入力</h2>
        <form id="entry-form">
          <label>
            日付
            <input type="date" id="date" required>
          </label>

          <label>
            種別
            <select id="io">
              <option value="expense">支出</option>
              <option value="income">収入</option>
            </select>
          </label>

          <label>
            カテゴリ
            <input list="category-list" id="category" placeholder="食費, 交通費, 日用品 など">
            <datalist id="category-list"></datalist>
          </label>

          <label>
            金種
            <select id="method">
              <option value="cash">現金</option>
              <option value="card">カード</option>
              <option value="point">ポイント</option>
              <option value="other">その他</option>
            </select>
          </label>

          <label>
            店名
            <input list="shop-list" id="shop" placeholder="スーパーA, コンビニB など">
            <datalist id="shop-list"></datalist>
          </label>

          <label>
            金額（円）
            <input type="number" id="amount" inputmode="numeric" required>
          </label>

          <label>
            メモ
            <input type="text" id="memo" placeholder="任意">
          </label>

          <button type="submit" class="primary-btn">追加</button>
        </form>
      </div>

      <div class="card">
        <h2>基準残高</h2>
        <p class="small-text">
          財布の中身がはっきりわかるタイミング（月初など）で、
          「この日に財布にいくらあったか」を登録しておきます。
        </p>

        <label>
          基準日
          <input type="date" id="baseline-date">
        </label>

        <label>
          財布の残高（円）
          <input type="number" id="baseline-amount" inputmode="numeric">
        </label>

        <button id="save-baseline" class="primary-btn">基準を保存</button>

        <p class="small-text" id="current-baseline-info" style="margin-top:8px;"></p>
      </div>
    </section>

    <!-- ================= カレンダータブ ================= -->
    <section id="view-calendar" class="view">
      <div class="card">
        <h2>カレンダー</h2>

        <label>
          表示する月
          <input type="month" id="calendar-month-select">
        </label>

        <div class="calendar-grid" id="calendar-grid"></div>

        <p class="small-text" style="margin-top:8px;">
          日付をタップすると下にその日の明細が表示されます。
        </p>
      </div>

      <div class="card">
        <h2>日別 / 財布照合</h2>

        <label>
          表示する日
          <input type="date" id="day-select">
        </label>

        <div class="records" id="day-records"></div>
        <div class="empty" id="day-empty" style="display:none;">この日のデータはまだありません。</div>

        <div class="summary">
          <span class="label">その日の支出合計</span>
          <span class="value" id="day-expense-total">0 円</span>
        </div>
        <div class="summary">
          <span class="label">その日の収入合計</span>
          <span class="value" id="day-income-total">0 円</span>
        </div>
        <div class="summary">
          <span class="label">その日の現金支出</span>
          <span class="value" id="day-cash-expense-total">0 円</span>
        </div>

        <p class="section-title">基準から見た財布残高（理論値）</p>
        <p class="small-text" id="expected-cash-text">
          基準点が設定されていません。
        </p>

        <div class="inline-input">
          <input type="number" id="actual-wallet" inputmode="numeric" placeholder="実際の財布残高（円）">
          <button type="button" id="calc-diff">差額計算</button>
        </div>
        <p class="small-text" id="wallet-diff-text"></p>

      </div>
    </section>

    <!-- ================= レポートタブ ================= -->
    <section id="view-report" class="view">
      <div class="card">
        <h2>月別レポート</h2>

        <label>
          表示する月
          <input type="month" id="month-select">
        </label>

        <!-- 全体サマリ（支出のみ） -->
        <div class="summary">
          <span class="label">月合計（支出のみ）</span>
          <span class="value" id="month-total">0 円</span>
        </div>
        <div class="summary">
          <span class="label">現金</span>
          <span class="value" id="month-cash">0 円</span>
        </div>
        <div class="summary">
          <span class="label">カード</span>
          <span class="value" id="month-card">0 円</span>
        </div>
        <div class="summary">
          <span class="label">ポイント</span>
          <span class="value" id="month-point">0 円</span>
        </div>
        <div class="summary">
          <span class="label">その他</span>
          <span class="value" id="month-other">0 円</span>
        </div>

        <!-- 円グラフ -->
        <p class="section-title">カテゴリ別支出（円グラフ）</p>
        <canvas id="category-pie" width="300" height="300"></canvas>
        <div id="no-chart-message" class="no-chart" style="display:none;">
          この月の支出データがまだありません。
        </div>

        <!-- 予算と進捗 -->
        <p class="section-title">カテゴリ別 予算と進捗</p>
        <p class="small-text">
          予算は「毎月共通」で使います。カテゴリを指定して月の目安額を登録してください。
        </p>

        <label>
          カテゴリ
          <input list="category-list" id="budget-category" placeholder="食費, 交通費 など">
        </label>
        <label>
          月の予算（円）
          <input type="number" id="budget-amount" inputmode="numeric">
        </label>
        <button id="save-budget" class="primary-btn">予算を登録 / 更新</button>

        <div id="budget-progress-list"></div>

        <div class="budget-list" id="budget-list"></div>

        <!-- 月の明細一覧 -->
        <p class="section-title" style="margin-top:12px;">この月の明細（支出）</p>
        <div class="records" id="month-records"></div>
        <div class="empty" id="month-empty" style="display:none;">この月のデータはまだありません。</div>
      </div>
    </section>

    <!-- ================= メニュータブ ================= -->
    <section id="view-menu" class="view">
      <div class="card">
        <h2>メニュー</h2>
        <p class="small-text">
          ここには今後、データのバックアップ（CSVエクスポート）や、
          アプリのバージョン情報などを置いていく予定。
        </p>
      </div>
    </section>
  </div>

  <!-- タブバー -->
  <div class="tab-bar">
    <button class="tab-button active" data-tab="input">入力</button>
    <button class="tab-button" data-tab="calendar">カレンダー</button>
    <button class="tab-button" data-tab="report">レポート</button>
    <button class="tab-button" data-tab="menu">メニュー</button>
  </div>

  <script>
    const APP_VERSION = 'v0.4.0';  // ← 好きな書式でOK。日付でも可
    const STORAGE_KEY_RECORDS = 'kakeibo_records_v3';
    const STORAGE_KEY_BASELINES = 'kakeibo_cash_baselines_v1';
    const STORAGE_KEY_BUDGETS = 'kakeibo_budgets_v1';

    function todayStr() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function monthStrFromDateStr(dateStr) {
      return dateStr.slice(0, 7);
    }

    function loadRecords() {
      const raw = localStorage.getItem(STORAGE_KEY_RECORDS);
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr.map(r => {
          const withIO = r.io ? r : { ...r, io: 'expense' };
          if (!('photoId' in withIO)) {
            withIO.photoId = null;
          }
          return withIO;
        });
      } catch {
        return [];
      }
    }

    function saveRecords(records) {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
    }

    function loadBaselines() {
      const raw = localStorage.getItem(STORAGE_KEY_BASELINES);
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveBaselines(baselines) {
      localStorage.setItem(STORAGE_KEY_BASELINES, JSON.stringify(baselines));
    }

    function loadBudgets() {
      const raw = localStorage.getItem(STORAGE_KEY_BUDGETS);
      if (!raw) return {};
      try {
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      } catch {
        return {};
      }
    }

    function saveBudgets(budgets) {
      localStorage.setItem(STORAGE_KEY_BUDGETS, JSON.stringify(budgets));
    }

    const records = loadRecords();
    const baselines = loadBaselines();
    const budgets = loadBudgets();

    // ===== DOM =====
    const dateInput = document.getElementById('date');
	const appVersionSpan = document.getElementById('app-version');
	if (appVersionSpan) {
	  appVersionSpan.textContent = APP_VERSION;
	}
    const ioSelect = document.getElementById('io');
    const categoryInput = document.getElementById('category');
    const categoryList = document.getElementById('category-list');
    const methodSelect = document.getElementById('method');
    const shopInput = document.getElementById('shop');
    const shopList = document.getElementById('shop-list');
    const amountInput = document.getElementById('amount');
    const memoInput = document.getElementById('memo');
    const entryForm = document.getElementById('entry-form');

    const baselineDateInput = document.getElementById('baseline-date');
    const baselineAmountInput = document.getElementById('baseline-amount');
    const saveBaselineBtn = document.getElementById('save-baseline');
    const currentBaselineInfo = document.getElementById('current-baseline-info');

    const calendarMonthSelect = document.getElementById('calendar-month-select');
    const calendarGrid = document.getElementById('calendar-grid');

    const daySelect = document.getElementById('day-select');
    const dayExpenseTotalEl = document.getElementById('day-expense-total');
    const dayIncomeTotalEl = document.getElementById('day-income-total');
    const dayCashExpenseTotalEl = document.getElementById('day-cash-expense-total');
    const expectedCashText = document.getElementById('expected-cash-text');
    const actualWalletInput = document.getElementById('actual-wallet');
    const calcDiffBtn = document.getElementById('calc-diff');
    const walletDiffText = document.getElementById('wallet-diff-text');
    const dayRecordsContainer = document.getElementById('day-records');
    const dayEmpty = document.getElementById('day-empty');

    const monthSelect = document.getElementById('month-select');
    const monthTotalEl = document.getElementById('month-total');
    const monthCashEl = document.getElementById('month-cash');
    const monthCardEl = document.getElementById('month-card');
    const monthPointEl = document.getElementById('month-point');
    const monthOtherEl = document.getElementById('month-other');
    const monthRecordsContainer = document.getElementById('month-records');
    const monthEmpty = document.getElementById('month-empty');

    const budgetCategoryInput = document.getElementById('budget-category');
    const budgetAmountInput = document.getElementById('budget-amount');
    const saveBudgetBtn = document.getElementById('save-budget');
    const budgetProgressList = document.getElementById('budget-progress-list');
    const budgetListEl = document.getElementById('budget-list');

    const tabButtons = document.querySelectorAll('.tab-button');
    const views = document.querySelectorAll('.view');

    const pieCanvas = document.getElementById('category-pie');
    const noChartMessage = document.getElementById('no-chart-message');
    let reportPieChart = null;

    let lastExpectedCash = null;

    const today = todayStr();
    dateInput.value = today;
    daySelect.value = today;
    const [y, m] = today.split('-');
    baselineDateInput.value = `${y}-${m}-01`;
    calendarMonthSelect.value = monthStrFromDateStr(today);
    monthSelect.value = monthStrFromDateStr(today);

    // ===== タブ切り替え =====
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        views.forEach(v => {
          v.classList.toggle('active', v.id === `view-${tab}`);
        });
        tabButtons.forEach(b => b.classList.toggle('active', b === btn));
      });
    });

    // ===== datalist 更新 =====
    function updateDatalists() {
      const categorySet = new Set();
      const shopSet = new Set();
      for (const r of records) {
        if (r.category) categorySet.add(r.category);
        if (r.shop) shopSet.add(r.shop);
      }

      categoryList.innerHTML = '';
      categorySet.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        categoryList.appendChild(opt);
      });

      shopList.innerHTML = '';
      shopSet.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        shopList.appendChild(opt);
      });
    }

    // ===== 基準点関連 =====
    function getBaselineForDate(dateStr) {
      if (baselines.length === 0) return null;
      const candidates = baselines
        .filter(b => b.date <= dateStr)
        .sort((a, b) => (a.date < b.date ? 1 : -1));
      return candidates[0] || null;
    }

    function renderBaselineInfo() {
      const targetDate = daySelect.value || todayStr();
      const baseline = getBaselineForDate(targetDate);
      if (!baseline) {
        currentBaselineInfo.textContent = 'この日以前の基準点は未設定です。';
      } else {
        currentBaselineInfo.textContent =
          `この日以前で最新の基準: ${baseline.date} 時点で ` +
          `${baseline.amount.toLocaleString()} 円`;
      }
    }

    saveBaselineBtn.addEventListener('click', () => {
      const date = baselineDateInput.value;
      const amountStr = baselineAmountInput.value;
      const amount = Number(amountStr);

      if (!date || !amountStr || isNaN(amount)) {
        alert('基準日と金額を入力してください');
        return;
      }

      baselines.push({ id: Date.now(), date, amount });
      baselines.sort((a, b) => (a.date > b.date ? 1 : -1));
      saveBaselines(baselines);
      baselineAmountInput.value = '';

      renderBaselineInfo();
      renderDaySection();
      alert('基準を保存しました');
    });

    // ===== 写真ID生成 =====
    function generatePhotoId(date) {
      const sameDay = records.filter(r => r.date === date);
      let maxSeq = 0;
      for (const r of sameDay) {
        if (r.photoId) {
          const match = String(r.photoId).match(/_(\d{2})$/);
          if (match) {
            const n = parseInt(match[1], 10);
            if (!isNaN(n) && n > maxSeq) {
              maxSeq = n;
            }
          }
        }
      }
      const next = maxSeq + 1;
      const seqStr = String(next).padStart(2, '0');
      return `${date}_${seqStr}`;
    }

    // ===== レコード削除 =====
    function deleteRecord(id) {
      const idx = records.findIndex(r => r.id === id);
      if (idx === -1) return;
      const ok = confirm('この明細を削除しますか？');
      if (!ok) return;
      records.splice(idx, 1);
      saveRecords(records);
      renderAll();
    }

    // ===== 入力 =====
    entryForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const date = dateInput.value;
      const io = ioSelect.value;
      const category = categoryInput.value.trim();
      const method = methodSelect.value;
      const shop = shopInput.value.trim();
      const amountStr = amountInput.value;
      const memo = memoInput.value.trim();

      const amount = Number(amountStr);
      if (!date || !amountStr || isNaN(amount)) {
        alert('日付と金額を入力してください');
        return;
      }

      const photoId = generatePhotoId(date);

      const record = {
        id: Date.now(),
        date,
        io,       // expense / income
        category,
        method,   // cash / card / point / other
        shop,
        amount,
        memo,
        photoId   // レシート紐づけ用ID
      };

      records.push(record);
      saveRecords(records);

      amountInput.value = '';
      memoInput.value = '';

      updateDatalists();
      renderAll();
    });

    // ===== カレンダー表示 =====
    function renderCalendar() {
      const month = calendarMonthSelect.value || monthStrFromDateStr(todayStr());
      calendarMonthSelect.value = month;

      const [yearStr, monthStr] = month.split('-');
      const year = Number(yearStr);
      const monthIdx = Number(monthStr) - 1;

      const firstDay = new Date(year, monthIdx, 1);
      const firstDow = firstDay.getDay();
      const startIndex = (firstDow + 6) % 7; // 月曜始まり
      const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();

      const byDate = {};
      for (const r of records) {
        if (!r.date.startsWith(month)) continue;
        if (!byDate[r.date]) {
          byDate[r.date] = { income: 0, expense: 0 };
        }
        if (r.io === 'income') {
          byDate[r.date].income += r.amount;
        } else {
          byDate[r.date].expense += r.amount;
        }
      }

      calendarGrid.innerHTML = '';

      const headerRow = document.createElement('div');
      headerRow.className = 'calendar-header-row';
      ['月','火','水','木','金','土','日'].forEach(w => {
        const cell = document.createElement('div');
        cell.className = 'calendar-header-cell';
        cell.textContent = w;
        headerRow.appendChild(cell);
      });
      calendarGrid.appendChild(headerRow);

      const cells = document.createElement('div');
      cells.className = 'calendar-cells';

      for (let i = 0; i < startIndex; i++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell empty';
        cells.appendChild(cell);
      }

      const todayStrVal = todayStr();
      const selectedDay = daySelect.value || todayStrVal;

		for (let d = 1; d <= daysInMonth; d++) {
		  const dayStr = String(d).padStart(2, '0');
		  const dateStr = `${yearStr}-${monthStr}-${dayStr}`;

		  const data = byDate[dateStr] || { income: 0, expense: 0 };

		  const cell = document.createElement('div');
		  cell.className = 'calendar-cell';

		  if (dateStr === todayStrVal) {
		    cell.classList.add('today');
		  }
		  if (dateStr === selectedDay) {
		    cell.classList.add('selected');
		  }

		  const num = document.createElement('div');
		  num.className = 'calendar-day-number';
		  num.textContent = d;
		  cell.appendChild(num);

		  // ★ここだけにする：その日の「支出合計」だけ1行表示（ラベルなし）
		  if (data.expense > 0) {
		    const total = document.createElement('div');
		    total.className = 'calendar-total expense';
		    total.textContent = `-${data.expense.toLocaleString()}`;
		    cell.appendChild(total);
		  }

		  cell.addEventListener('click', () => {
		    daySelect.value = dateStr;
		    renderBaselineInfo();
		    renderDaySection();
		    renderCalendar(); // 選択ハイライト更新
		  });

		  cells.appendChild(cell);
		}

      calendarGrid.appendChild(cells);
    }

    calendarMonthSelect.addEventListener('change', () => {
      renderCalendar();
    });

    // ===== 日別表示 =====
    function renderDaySection() {
      const day = daySelect.value || todayStr();

      const list = records
        .filter(r => r.date === day)
        .sort((a, b) => a.id - b.id);

      dayRecordsContainer.innerHTML = '';

      if (list.length === 0) {
        dayEmpty.style.display = 'block';
      } else {
        dayEmpty.style.display = 'none';
      }

      let expenseTotal = 0;
      let incomeTotal = 0;
      let cashExpenseTotal = 0;

      for (const r of list) {
        if (r.io === 'income') {
          incomeTotal += r.amount;
        } else {
          expenseTotal += r.amount;
          if (r.method === 'cash') {
            cashExpenseTotal += r.amount;
          }
        }

        const div = document.createElement('div');
        div.className = 'record-item';

        const top = document.createElement('div');
        top.className = 'record-top';

        const left = document.createElement('div');
        left.className = 'record-left';
        left.textContent =
          `${r.category || '未分類'} / ${r.shop || '店名なし'} / ${methodLabel(r.method)}`;

        const right = document.createElement('div');
        right.className = 'record-amount ' + (r.io === 'income' ? 'income' : 'expense');
        const sign = r.io === 'income' ? '+' : '-';
        right.textContent = `${sign}${r.amount.toLocaleString()} 円`;

        top.appendChild(left);
        top.appendChild(right);
        div.appendChild(top);

        if (r.memo) {
          const meta = document.createElement('div');
          meta.className = 'record-meta';
          meta.textContent = r.memo;
          div.appendChild(meta);
        }

        if (r.photoId) {
          const photoRow = document.createElement('div');
          photoRow.className = 'photo-id-row';

          const label = document.createElement('span');
          label.className = 'photo-id-label';
          label.textContent = '写真ID';

          const value = document.createElement('span');
          value.className = 'photo-id-value';
          value.textContent = r.photoId;

          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'photo-id-copy-btn';
          copyBtn.textContent = 'コピー';

          copyBtn.addEventListener('click', async () => {
            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(r.photoId);
                alert('写真IDをコピーしました');
              } else {
                const textarea = document.createElement('textarea');
                textarea.value = r.photoId;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('写真IDをコピーしました');
              }
            } catch (e) {
              alert('コピーに失敗しました。手動で選択してください。');
            }
          });

          photoRow.appendChild(label);
          photoRow.appendChild(value);
          photoRow.appendChild(copyBtn);
          div.appendChild(photoRow);
        }

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'delete-btn';
        delBtn.textContent = '削除';
        delBtn.addEventListener('click', () => deleteRecord(r.id));
        div.appendChild(delBtn);

        dayRecordsContainer.appendChild(div);
      }

      dayExpenseTotalEl.textContent = `${expenseTotal.toLocaleString()} 円`;
      dayIncomeTotalEl.textContent = `${incomeTotal.toLocaleString()} 円`;
      dayCashExpenseTotalEl.textContent = `${cashExpenseTotal.toLocaleString()} 円`;

      const baseline = getBaselineForDate(day);
      if (!baseline) {
        expectedCashText.textContent = 'この日以前の基準点がないため計算できません。';
        lastExpectedCash = null;
      } else {
        const cashExpense = records
          .filter(r =>
            r.method === 'cash' &&
            r.date >= baseline.date &&
            r.date <= day &&
            r.io === 'expense'
          )
          .reduce((sum, r) => sum + r.amount, 0);

        const cashIncome = records
          .filter(r =>
            r.method === 'cash' &&
            r.date >= baseline.date &&
            r.date <= day &&
            r.io === 'income'
          )
          .reduce((sum, r) => sum + r.amount, 0);

        const expected = baseline.amount - cashExpense + cashIncome;
        lastExpectedCash = expected;

        expectedCashText.innerHTML =
          `基準 ${baseline.date} の <span class="highlight">${baseline.amount.toLocaleString()} 円</span> から ` +
          `この日までの現金支出 <span class="highlight">${cashExpense.toLocaleString()} 円</span> と ` +
          `現金収入 <span class="highlight">${cashIncome.toLocaleString()} 円</span> を反映すると、` +
          `<br>この日の理論上の財布残高は <span class="highlight">${expected.toLocaleString()} 円</span> です。`;
      }

      walletDiffText.textContent = '';
    }

    daySelect.addEventListener('change', () => {
      renderBaselineInfo();
      renderDaySection();
      renderCalendar(); // カレンダーの選択ハイライト更新
    });

    calcDiffBtn.addEventListener('click', () => {
      if (lastExpectedCash === null) {
        alert('まず基準点を設定し、日付を指定してください。');
        return;
      }

      const actualStr = actualWalletInput.value;
      const actual = Number(actualStr);
      if (!actualStr || isNaN(actual)) {
        alert('実際の財布残高を入力してください');
        return;
      }

      const diff = actual - lastExpectedCash;
      let msg = '';

      if (diff === 0) {
        msg = '記録どおりです。差額はありません。';
      } else if (diff > 0) {
        msg = `実際の方が <span class="highlight">${diff.toLocaleString()} 円</span> 多いです。`;
      } else {
        msg = `実際の方が <span class="highlight">${Math.abs(diff).toLocaleString()} 円</span> 少ないです。`;
      }

      walletDiffText.innerHTML = msg;
    });

    // ===== 月別集計（支出のみ） & レポート =====
    function renderMonthSection() {
      const month = monthSelect.value || monthStrFromDateStr(todayStr());
      monthSelect.value = month;

      const list = records
        .filter(r => r.date.startsWith(month) && r.io === 'expense')
        .sort((a, b) => (a.date < b.date ? 1 : -1));

      monthRecordsContainer.innerHTML = '';

      if (list.length === 0) {
        monthEmpty.style.display = 'block';
      } else {
        monthEmpty.style.display = 'none';
      }

      let total = 0;
      let cash = 0;
      let card = 0;
      let point = 0;
      let other = 0;

      const categoryTotals = {};

      for (const r of list) {
        total += r.amount;
        if (r.method === 'cash') cash += r.amount;
        else if (r.method === 'card') card += r.amount;
        else if (r.method === 'point') point += r.amount;
        else other += r.amount;

        const cat = r.category || '未分類';
        categoryTotals[cat] = (categoryTotals[cat] || 0) + r.amount;

        const div = document.createElement('div');
        div.className = 'record-item';

        const top = document.createElement('div');
        top.className = 'record-top';

        const left = document.createElement('div');
        left.className = 'record-left';
        left.textContent =
          `${r.date} / ${cat} / ${r.shop || '店名なし'} / ${methodLabel(r.method)}`;

        const right = document.createElement('div');
        right.className = 'record-amount expense';
        right.textContent = `-${r.amount.toLocaleString()} 円`;

        top.appendChild(left);
        top.appendChild(right);
        div.appendChild(top);

        if (r.memo) {
          const meta = document.createElement('div');
          meta.className = 'record-meta';
          meta.textContent = r.memo;
          div.appendChild(meta);
        }

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'delete-btn';
        delBtn.textContent = '削除';
        delBtn.addEventListener('click', () => deleteRecord(r.id));
        div.appendChild(delBtn);

        monthRecordsContainer.appendChild(div);
      }

      monthTotalEl.textContent = `${total.toLocaleString()} 円`;
      monthCashEl.textContent = `${cash.toLocaleString()} 円`;
      monthCardEl.textContent = `${card.toLocaleString()} 円`;
      monthPointEl.textContent = `${point.toLocaleString()} 円`;
      monthOtherEl.textContent = `${other.toLocaleString()} 円`;

      renderCategoryPieChart(categoryTotals);
      renderBudgetProgress(categoryTotals);
      renderBudgetList();
    }

    monthSelect.addEventListener('change', renderMonthSection);

    // ===== 円グラフ描画 =====
    function renderCategoryPieChart(categoryTotals) {
      const labels = Object.keys(categoryTotals);
      const data = labels.map(l => categoryTotals[l]);

      if (labels.length === 0) {
        if (reportPieChart) {
          reportPieChart.destroy();
          reportPieChart = null;
        }
        noChartMessage.style.display = 'block';
        return;
      }

      noChartMessage.style.display = 'none';

      if (reportPieChart) {
        reportPieChart.destroy();
      }

      reportPieChart = new Chart(pieCanvas, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    // ===== 予算の進捗表示 =====
    function renderBudgetProgress(categoryTotals) {
      budgetProgressList.innerHTML = '';

      const allCats = new Set([
        ...Object.keys(categoryTotals),
        ...Object.keys(budgets)
      ]);

      if (allCats.size === 0) {
        return;
      }

      allCats.forEach(cat => {
        const used = categoryTotals[cat] || 0;
        const budget = budgets[cat] || null;

        const row = document.createElement('div');
        row.className = 'budget-row';

        const header = document.createElement('div');
        header.className = 'budget-row-header';

        const left = document.createElement('span');
        left.textContent = cat;

        const right = document.createElement('span');
        if (budget) {
          const remain = budget - used;
          const remainText = remain >= 0
            ? `残り ${remain.toLocaleString()} 円`
            : `オーバー ${Math.abs(remain).toLocaleString()} 円`;
          right.textContent =
            `使った額 ${used.toLocaleString()} / 予算 ${budget.toLocaleString()} 円 (${remainText})`;
        } else {
          right.textContent = `使った額 ${used.toLocaleString()} 円 / 予算未設定`;
        }

        header.appendChild(left);
        header.appendChild(right);
        row.appendChild(header);

        if (budget && budget > 0) {
          const ratio = used / budget;
          const width = Math.min(100, Math.round(ratio * 100));
          const bar = document.createElement('div');
          bar.className = 'progress-bar';
          const inner = document.createElement('div');
          inner.className = 'progress-bar-inner';

          if (ratio < 0.7) inner.classList.add('progress-ok');
          else if (ratio <= 1) inner.classList.add('progress-warn');
          else inner.classList.add('progress-over');

          inner.style.width = `${width}%`;
          bar.appendChild(inner);
          row.appendChild(bar);
        }

        budgetProgressList.appendChild(row);
      });
    }

    // ===== 予算リスト表示 =====
    function renderBudgetList() {
      budgetListEl.innerHTML = '';
      const cats = Object.keys(budgets);
      if (cats.length === 0) {
        budgetListEl.textContent = '登録済みの予算はまだありません。';
        return;
      }

      cats.sort().forEach(cat => {
        const line = document.createElement('div');
        line.className = 'budget-item-line';

        const left = document.createElement('span');
        left.textContent = `${cat}: ${budgets[cat].toLocaleString()} 円 / 月`;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = '削除';
        btn.addEventListener('click', () => {
          const ok = confirm(`「${cat}」の予算を削除しますか？`);
          if (!ok) return;
          delete budgets[cat];
          saveBudgets(budgets);
          renderMonthSection();
        });

        line.appendChild(left);
        line.appendChild(btn);
        budgetListEl.appendChild(line);
      });
    }

    // ===== 予算登録 =====
    saveBudgetBtn.addEventListener('click', () => {
      const cat = budgetCategoryInput.value.trim();
      const amtStr = budgetAmountInput.value;
      const amt = Number(amtStr);

      if (!cat || !amtStr || isNaN(amt)) {
        alert('カテゴリと予算額を入力してください');
        return;
      }

      budgets[cat] = amt;
      saveBudgets(budgets);
      budgetCategoryInput.value = '';
      budgetAmountInput.value = '';

      renderMonthSection();
      alert('予算を登録 / 更新しました');
    });

    function methodLabel(method) {
      switch (method) {
        case 'cash': return '現金';
        case 'card': return 'カード';
        case 'point': return 'ポイント';
        default: return 'その他';
      }
    }

    function renderAll() {
      updateDatalists();
      renderBaselineInfo();
      renderDaySection();
      renderCalendar();
      renderMonthSection();
    }

    renderAll();
  </script>
</body>
</html>
